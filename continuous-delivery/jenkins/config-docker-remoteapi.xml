<?xml version='1.0' encoding='UTF-8'?>
<maven2-moduleset plugin="maven-plugin@2.7.1">
  <actions/>
  <description></description>
  <keepDependencies>false</keepDependencies>
  <properties/>
  <scm class="hudson.plugins.git.GitSCM" plugin="git@2.4.4">
    <configVersion>2</configVersion>
    <userRemoteConfigs>
      <hudson.plugins.git.UserRemoteConfig>
        <url>https://github.com/tecris/continuous-delivery.git</url>
      </hudson.plugins.git.UserRemoteConfig>
    </userRemoteConfigs>
    <branches>
      <hudson.plugins.git.BranchSpec>
        <name>*/master</name>
      </hudson.plugins.git.BranchSpec>
    </branches>
    <doGenerateSubmoduleConfigurations>false</doGenerateSubmoduleConfigurations>
    <submoduleCfg class="list"/>
    <extensions>
      <hudson.plugins.git.extensions.impl.LocalBranch>
        <localBranch>master</localBranch>
      </hudson.plugins.git.extensions.impl.LocalBranch>
    </extensions>
  </scm>
  <canRoam>true</canRoam>
  <disabled>false</disabled>
  <blockBuildWhenDownstreamBuilding>false</blockBuildWhenDownstreamBuilding>
  <blockBuildWhenUpstreamBuilding>false</blockBuildWhenUpstreamBuilding>
  <triggers>
    <hudson.triggers.SCMTrigger>
      <spec>H/2 * * * *</spec>
      <ignorePostCommitHooks>false</ignorePostCommitHooks>
    </hudson.triggers.SCMTrigger>
  </triggers>
  <concurrentBuild>true</concurrentBuild>
  <rootModule>
    <groupId>org.terra</groupId>
    <artifactId>planet</artifactId>
  </rootModule>
  <goals>clean deploy -DskipITs</goals>
  <aggregatorStyleBuild>true</aggregatorStyleBuild>
  <incrementalBuild>false</incrementalBuild>
  <ignoreUpstremChanges>false</ignoreUpstremChanges>
  <archivingDisabled>false</archivingDisabled>
  <siteArchivingDisabled>false</siteArchivingDisabled>
  <fingerprintingDisabled>false</fingerprintingDisabled>
  <resolveDependencies>false</resolveDependencies>
  <processPlugins>false</processPlugins>
  <mavenValidationLevel>-1</mavenValidationLevel>
  <runHeadless>false</runHeadless>
  <disableTriggerDownstreamProjects>false</disableTriggerDownstreamProjects>
  <blockTriggerWhenBuilding>true</blockTriggerWhenBuilding>
  <settings class="jenkins.mvn.DefaultSettingsProvider"/>
  <globalSettings class="jenkins.mvn.FilePathGlobalSettingsProvider">
    <path>/opt/maven_config/.m2/settings.xml</path>
  </globalSettings>
  <reporters/>
  <publishers/>
  <buildWrappers/>
  <prebuilders/>
  <postbuilders>
    <hudson.tasks.Shell>
      <command>echo &quot;\n\n===== Stop database container (if any) =====\n\n&quot;
curl -X POST http://docker.host:4243/containers/planets-mysql-db/stop

echo &quot;\n\n===== Remove database container (if any) =====\n\n&quot;
curl -X DELETE http://docker.host:4243/containers/planets-mysql-db

echo &quot;\n\n===== Create database container =====\n\n&quot;
curl -X POST -H &quot;Content-Type: application/json&quot; -d &apos;{
  &quot;Hostname&quot;: &quot;planets.db&quot;,
  &quot;Image&quot;: &quot;mysql:5.7&quot;,
  &quot;Env&quot;: [
    &quot;MYSQL_ROOT_PASSWORD=mysql&quot;,
    &quot;MYSQL_USER=bookstore&quot;,
    &quot;MYSQL_PASSWORD=1bookstore!&quot;,
    &quot;MYSQL_DATABASE=bookstoredb&quot;
  ],
  &quot;ExposedPorts&quot;: {
    &quot;3306/tcp&quot;: {}
  }
}&apos; http://docker.host:4243/containers/create?name=planets-mysql-db

echo &quot;\n\n===== Start database container =====\n\n&quot;
curl -v -X POST -H &quot;Content-Type: application/json&quot; -d &apos;{
  &quot;PortBindings&quot;: {
    &quot;3306/tcp&quot;: [{
      &quot;HostPort&quot;: &quot;3306&quot;
    }]
  },
  &quot;RestartPolicy&quot;: {
    &quot;Name&quot;: &quot;always&quot;
  }
}&apos; http://docker.host:4243/containers/planets-mysql-db/start

echo &quot;\n\n===== Wait for database container to start =====\n\n&quot;
sleep 10

echo &quot;\n\n===== Deploy database scripts =====\n\n&quot;
mvn -s /opt/maven_config/.m2/settings.xml clean compile flyway:migrate -Ddatabase.host=docker.host

echo &quot;\n\n===== Get latest build from nexus repository =====\n\n&quot;
wget &quot;http://nexus:8081/service/local/artifact/maven/redirect?r=snapshots&amp;g=org.terra&amp;a=planet&amp;v=LATEST&amp;e=war&quot; -O $WORKSPACE/continuous-delivery/jenkins/docker/bookstore.war

echo &quot;\n\n===== Build archive required for docker remote API when building an image =====\n\n&quot;
tar zcf $WORKSPACE/continuous-delivery/Dockerfile.tar.gz -C $WORKSPACE/continuous-delivery/jenkins/docker/ .

echo &quot;\n\n===== Build web image =====\n\n&quot;
curl -X POST -H &quot;Content-Type: application/tar&quot; --data-binary @$WORKSPACE/continuous-delivery/Dockerfile.tar.gz http://docker.host:4243/build?t=planets-web:$BUILD_NUMBER

echo &quot;\n\n===== Cleanup, remote archive =====\n\n&quot;
rm $WORKSPACE/continuous-delivery/Dockerfile.tar.gz

echo &quot;\n\n===== Cleanup, stop database container =====\n\n&quot;
curl -X POST http://docker.host:4243/containers/planets-mysql-db/stop

echo &quot;\n\n===== Cleanup, remove database container =====\n\n&quot;
curl -X DELETE http://docker.host:4243/containers/planets-mysql-db
</command>
    </hudson.tasks.Shell>
  </postbuilders>
  <runPostStepsIfResult>
    <name>SUCCESS</name>
    <ordinal>0</ordinal>
    <color>BLUE</color>
    <completeBuild>true</completeBuild>
  </runPostStepsIfResult>
</maven2-moduleset>